Saltar al contenido
Historial del chat

Dijiste:
tengo este script de google, que esta funcionando perfectamente para una app que sube la asistencia y para otra que la lee y la muestra, pero quiero hacer un html con pwa para proyectar la asistencia en otra pantalla, o sea quiero una app de control en donde pueda elegir entre las pantallas disponibles y proyectar la asistencia que yo quiera, la app debe tener mas o menos una interfaz asi:  en la parte superior debe aparecer el encabezado de la app asistencia ipuc bochica sur, abajito debe decir asistencia de: y ahi sale el mes actual o el que se seleccione, en la parte central y es la mas importante la parte donde muestra la asitencia de ese mes, que la trae desde la hoja de calculo, que viene asi: usuario, fecha, hermanos, hermanas, amigos, adolescentes, ni√±os y total asistencia, esos son los encabezados, y los valores los listas con el script desde la hoja de calculo, debe tener un boton ver mes que lista la asistencia del mes actual, otro ver hoy que lista solo la asistencia dl dia actual, otro buscar que permite buscar un mes en especifico, otro que diga proyectar  y un combobox donde se seleccione la pantalla para proyectar                                                                                                                    function doGet(e) { 
  var ss = SpreadsheetApp.openById("1oVlNqDvC-Cr8l_zF_maRSZJllZJ6GgJVEqj32IMLO-E");
  var accion = e.parameter.accion || "insertar"; // por defecto insertar
  
  var meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
               "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
  
  // --- 1. ACCI√ìN 'insertar' (DUPLICADO y Registro) ---
  if (accion === "insertar") {
    var usuario = e.parameter.usuario || "Anonimo";
    var claveVerificacion = "last_attendance_" + usuario;
    var TIEMPO_LIMITE_MS = 10 * 1000; // 10 segundos

    var properties = PropertiesService.getScriptProperties();
    var ultimaAsistenciaStr = properties.getProperty(claveVerificacion);
    var ahora = new Date().getTime(); 

    if (ultimaAsistenciaStr) {
      var ultimaAsistenciaMs = parseInt(ultimaAsistenciaStr, 10);
      
      if (ahora - ultimaAsistenciaMs < TIEMPO_LIMITE_MS) {
        return ContentService.createTextOutput("DUPLICADO");
      }
    }

    properties.setProperty(claveVerificacion, ahora.toString());

    var fechaCompleta = e.parameter.fecha || "";
    var mesNombre = "SinFecha";

    if (fechaCompleta) {
      // Extrae el mes del formato dd/MM/yyyy
      var partesFechaHora = fechaCompleta.split(" ");
      var soloFecha = partesFechaHora[0];
      var partes = soloFecha.split("/");
      var mes = parseInt(partes[1], 10) - 1;
      mesNombre = meses[mes];
    } 

    var hoja = ss.getSheetByName(mesNombre);
    if (!hoja) {
      hoja = ss.insertSheet(mesNombre);
      var encabezados = [
        "Usuario", "Fecha", "Hermanos", "Hermanas", "Amigos", "Adolescentes", "Ni√±os", "Total Asistencia"
      ];
      hoja.appendRow(encabezados);
      var rangoEncabezados = hoja.getRange(1, 1, 1, encabezados.length);
      rangoEncabezados.setFontWeight("bold");
      rangoEncabezados.setHorizontalAlignment("center");
      rangoEncabezados.setBackground("#d9ead3");
    }

    hoja.setFrozenRows(1);

    hoja.appendRow([
      usuario, 
      fechaCompleta,
      e.parameter.hermanos || "0",
      e.parameter.hermanas || "0",
      e.parameter.amigos || "0",
      e.parameter.adolescentes || "0",
      e.parameter.ni√±os || "0",
      e.parameter.total || "0"
    ]);

    hoja.autoResizeColumn(1);
    hoja.autoResizeColumn(2);

    return ContentService.createTextOutput("OK");
  }

// ----------------------------------------------------------------------------------

  // --- 2. ACCI√ìN 'eliminar' (por usuario+fecha o √∫ltimos 10 minutos) ---
if (accion === "eliminar") {
  var usuarioParam = e.parameter.usuario;
  var fechaParam = e.parameter.fecha;

  var fechaActual = new Date();
  var ahora = fechaActual.getTime();
  var TIEMPO_CORTE_MS = 10 * 60 * 1000; // 10 minutos
  var tiempoLimiteMs = ahora - TIEMPO_CORTE_MS;

  var mesNombre = meses[fechaActual.getMonth()];
  var hoja = ss.getSheetByName(mesNombre);
  if (!hoja) {
    return ContentService.createTextOutput("HOJA_NO_ENCONTRADA");
  }

  var datos = hoja.getDataRange().getValues();
  var zonaHoraria = ss.getSpreadsheetTimeZone();
  var fechaHoy = Utilities.formatDate(fechaActual, zonaHoraria, "dd/MM/yyyy");
  var filasEliminadasCount = 0;

  // üîπ 1Ô∏è‚É£ Caso: eliminar por usuario y fecha exacta
  if (usuarioParam && fechaParam) {
    for (var i = datos.length - 1; i >= 1; i--) {
      var usuarioCelda = (datos[i][0] || "").toString().trim().toLowerCase();
      var fechaCelda = (datos[i][1] || "").toString().trim();
      if (
        usuarioCelda === usuarioParam.toLowerCase().trim() &&
        fechaCelda === fechaParam.trim()
      ) {
        hoja.deleteRow(i + 1);
        filasEliminadasCount++;
      }
    }
    return ContentService.createTextOutput(
      filasEliminadasCount > 0 ? "ELIMINADA" : "NO_ENCONTRADA"
    );
  }

  // üîπ 2Ô∏è‚É£ Caso: eliminar √∫ltimos 10 minutos (versi√≥n anterior)
  for (var i = datos.length - 1; i >= 1; i--) {
    var fechaCelda = datos[i][1];
    var fechaRegistro = null;

    if (fechaCelda instanceof Date) {
      fechaRegistro = fechaCelda;
    } else {
      var fechaCeldaStr = fechaCelda.toString();
      var partes = fechaCeldaStr.match(
        /(\d{2})\/(\d{2})\/(\d{4})\s(\d{1,2}):(\d{2}):(\d{2})\s(a\.m\.|p\.m\.)/i
      );
      if (partes) {
        var dd = partes[1],
          MM = partes[2],
          yyyy = partes[3];
        var HH = parseInt(partes[4], 10);
        var mm = partes[5],
          ss = partes[6];
        var ampm = partes[7].toLowerCase();
        if (ampm === "p.m." && HH < 12) HH += 12;
        else if (ampm === "a.m." && HH === 12) HH = 0;
        fechaRegistro = new Date(
          yyyy,
          parseInt(MM, 10) - 1,
          dd,
          HH,
          mm,
          ss
        );
      }
    }

    if (fechaRegistro) {
      var fechaRegistroMs = fechaRegistro.getTime();
      var fechaRegistroDia = Utilities.formatDate(
        fechaRegistro,
        zonaHoraria,
        "dd/MM/yyyy"
      );
      var esHoy = fechaRegistroDia === fechaHoy;
      var enRango = fechaRegistroMs >= tiempoLimiteMs;

      if (esHoy && enRango) {
        hoja.deleteRow(i + 1);
        filasEliminadasCount++;
      }
    }
  }

  return ContentService.createTextOutput(
    filasEliminadasCount > 0
      ? "ELIMINADAS_" + filasEliminadasCount
      : "NO_ELIMINADAS"
  );
}


// ----------------------------------------------------------------------------------

  // --- 3. ACCI√ìN 'listar' ---
  if (accion === "listar") {
    var mesNombre = e.parameter.mes || "";
    var hoja = ss.getSheetByName(mesNombre);
    if (!hoja) {
      return ContentService.createTextOutput("[]").setMimeType(ContentService.MimeType.JSON);
    }

    var datos = hoja.getDataRange().getValues();

    var salida = datos.map(function(row) {
      return row.map(function(cell) {
        if (cell instanceof Date) {
          // Formato de salida para JSON
          return Utilities.formatDate(cell, "America/Bogota", "dd/MM/yyyy HH:mm:ss");
        }
        return cell;
      });
    });

    return ContentService.createTextOutput(JSON.stringify(salida))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}
ChatGPT dijo:
Perfecto, ya tengo claro tu backend (Apps Script) y lo que necesitas ahora: una PWA en HTML/JS que permita consultar y proyectar la asistencia en otra pantalla.

A continuaci√≥n te dejo un HTML funcional, con interfaz completa, botones, selector de mes, tabla din√°mica, selector de pantalla, y base para la proyecci√≥n en una segunda ventana.

üìå Este HTML NO afecta tu backend.
üìå Solo consume tu endpoint ?accion=listar&mes=
üìå Totalmente listo para convertirlo en PWA.

‚úÖ HTML COMPLETO ‚Äî Panel de Control + Proyecci√≥n
‚ö†Ô∏è Solo reemplaza TU_URL_DEL_SCRIPT con el enlace de tu Apps Script desplegado como Web App.

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Asistencia IPUC Bochica Sur</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0a5c30" />

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f1f5f1;
  }

  header {
    background: #0a5c30;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }

  #subtitulo {
    text-align: center;
    margin-top: 5px;
    font-size: 18px;
    font-weight: bold;
  }

  .panel {
    padding: 15px;
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  button {
    padding: 10px 15px;
    background: #0a5c30;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 6px;
  }

  button:hover {
    background: #0f7f47;
  }

  select {
    padding: 8px;
    border-radius: 5px;
  }

  table {
    width: 95%;
    margin: 15px auto;
    border-collapse: collapse;
    background: white;
  }

  th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid #ccc;
  }

  th {
    background: #d9ead3;
    font-weight: bold;
  }

</style>
</head>
<body>

<header>Asistencia IPUC Bochica Sur</header>

<div id="subtitulo">Asistencia de: <span id="mesActual"></span></div>

<div class="panel">
  <button onclick="verMesActual()">Ver Mes Actual</button>
  <button onclick="verHoy()">Ver Hoy</button>

  <select id="selectMes"></select>
  <button onclick="buscarMes()">Buscar</button>

  <select id="pantallaSelect">
    <option value="1">Pantalla 1</option>
    <option value="2">Pantalla 2</option>
    <option value="3">Pantalla 3</option>
  </select>
  <button onclick="proyectar()">Proyectar</button>
</div>

<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec"; // ‚ö†Ô∏è Coloca tu URL aqu√≠

const meses = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let ventanaProyeccion = null;

// ------------------------------------------------------
// Cargar combo de meses
// ------------------------------------------------------
const selectMes = document.getElementById("selectMes");
meses.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m;
  opt.textContent = m;
  selectMes.appendChild(opt);
});

// Mes actual
document.getElementById("mesActual").textContent = meses[new Date().getMonth()];

// ------------------------------------------------------
// Funci√≥n para consultar datos
// ------------------------------------------------------
async function cargarMes(mes) {
  document.getElementById("mesActual").textContent = mes;

  let url = `${URL}?accion=listar&mes=${encodeURIComponent(mes)}`;
  let res = await fetch(url);
  let data = await res.json();

  pintarTabla(data);
}

// ------------------------------------------------------
// Pintar tabla
// ------------------------------------------------------
function pintarTabla(data) {
  const thead = document.querySelector("#tabla thead");
  const tbody = document.querySelector("#tabla tbody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='8'>Sin datos</td></tr>";
    return;
  }

  // Encabezados
  let headers = data[0];
  let thRow = "<tr>";
  headers.forEach(h => thRow += `<th>${h}</th>`);
  thRow += "</tr>";
  thead.innerHTML = thRow;

  // Filas
  for (let i = 1; i < data.length; i++) {
    let row = "<tr>";
    data[i].forEach(cell => row += `<td>${cell}</td>`);
    row += "</tr>";
    tbody.innerHTML += row;
  }
}

// ------------------------------------------------------
// Bot√≥n: Ver Mes Actual
// ------------------------------------------------------
function verMesActual() {
  let mes = meses[new Date().getMonth()];
  cargarMes(mes);
}

// ------------------------------------------------------
// Bot√≥n: Ver Hoy
// ------------------------------------------------------
async function verHoy() {
  let mes = meses[new Date().getMonth()];
  let url = `${URL}?accion=listar&mes=${mes}`;

  let res = await fetch(url);
  let data = await res.json();

  const hoy = new Date().toLocaleDateString("es-CO");

  let filtrados = data.filter(row => row[1] && row[1].includes(hoy));
  if (filtrados.length > 0) filtrados.unshift(data[0]);

  document.getElementById("mesActual").textContent = "Hoy";
  pintarTabla(filtrados);
}

// ------------------------------------------------------
// Bot√≥n: Buscar Mes
// ------------------------------------------------------
function buscarMes() {
  let mes = selectMes.value;
  cargarMes(mes);
}

// ------------------------------------------------------
// Bot√≥n: Proyectar en otra pantalla
// ------------------------------------------------------
function proyectar() {
  const pantalla = document.getElementById("pantallaSelect").value;

  if (!ventanaProyeccion || ventanaProyeccion.closed) {
    ventanaProyeccion = window.open("", "proyeccion", "width=1000,height=600");
  }

  ventanaProyeccion.document.body.innerHTML = `
    <h1 style="text-align:center;">Asistencia ${document.getElementById("mesActual").textContent}</h1>
    ${document.getElementById("tabla").outerHTML}
  `;
}

</script>

</body>
</html>
‚úÖ Qu√© Incluye Esta PWA
‚úî Encabezado
"Asistencia IPUC Bochica Sur"

‚úî Subt√≠tulo
"Asistencia de: MES"

‚úî Tabla din√°mica
Carga desde tu Apps Script seg√∫n mes.

‚úî Botones funcionales
Ver Mes Actual

Ver Hoy

Buscar Mes

Proyectar (duplica la vista en otra pantalla/ventana)

‚úî Selector de pantalla
Puedes agregar o quitar pantallas f√°cilmente.

‚úî Base para PWA
Incluye manifest.json (debes crearlo) y luego podr√°s agregar un service worker.

üìå ¬øQuieres que tambi√©n te cree?
‚úî El manifest.json
‚úî El service-worker.js
‚úî La versi√≥n mejorada para el proyector (sin controles, solo la tabla)
‚úî Estilos modernos (Material, Bootstrap, Tailwind)
‚úî Bot√≥n de actualizaci√≥n autom√°tica cada X segundos

Solo dime "crear PWA completa" y te la entrego lista.

Is this conversation helpful so far?






Sin archivos seleccionadosSin archivos seleccionados
ChatGPT puede cometer errores. Comprueba la informaci√≥n importante. Consulta Preferencias de cookies.
