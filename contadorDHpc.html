<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#1E6FB8" />
<title>Asistencia IPUC Bochica Sur</title>

<link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">



<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #ffffff;           /* fondo blanco puro */
  color: #000;
  min-height: 100vh;
  position: relative;
}

/* MARCA DE AGUA ‚Üí AHORA S√ç SE VE PERFECTO */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: url('fondo.png') center center / 92% auto no-repeat;
  opacity: 0.20;                  /* ‚Üê aqu√≠ controlas cu√°nto se ve */
  pointer-events: none;
  z-index: -1;
}

/* En m√≥vil m√°s tenue */
@media (max-width: 768px) {
  body::before { opacity: 0.10; }   /* o 0.08 si quieres a√∫n m√°s suave */
}

header {
  background: rgba(30, 111, 184, 0.96); /* Un poco m√°s s√≥lido para que se lea bien sobre el fondo */
  color: white;
  padding: 15px;
  text-align: center;
  font-size: 22px;
  font-weight: bold;
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

/* SUBT√çTULO PRINCIPAL GRANDE Y MODERNO ‚Äì AHORA CON EFECTO CRISTAL */
#subtitulo {
  margin-top: 22px;
  margin-bottom: 10px;
  text-align: center;
  font-size: clamp(28px, 4vw, 44px);
  font-weight: 800;
  letter-spacing: 1.2px;
  color: #1E6FB8;
  background: rgba(255, 255, 255, 0.88);
  padding: 16px 24px;
  border-radius: 20px;
  backdrop-filter: blur(12px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.2;
  border: 1px solid rgba(255,255,255,0.3);
}
#subtitulo span {
  color: #000;
  font-weight: 900;
  text-transform: capitalize;
}

/* PANEL FIJO MODERNO ‚Äì MANTIENE SU ESTILO PERO CON MEJOR CONTRASTE */
.panel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 14px 20px;
  background: rgba(30, 111, 184, 0.96);
  backdrop-filter: blur(12px);
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: nowrap;
  z-index: 9999;
  box-shadow: 0 -6px 20px rgba(0,0,0,0.25);
  border-top: 1px solid rgba(255,255,255,0.2);
}
/* BOTONES PROFESIONALES */
.panel button {
  padding: 10px 18px;
  font-size: 15px;
  border-radius: 10px;
  border: none;
  background: white;
  color: #1E6FB8;
  font-weight: 600;
  cursor: pointer;
  transition: 0.25s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel button:hover {
  background: #e6f1ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.panel button:active {
  transform: scale(0.97);
}

/* SELECT STYLE MODERNO */
.panel select {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  background: #ffffff;
  font-weight: 600;
  color: #1E6FB8;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
  cursor: pointer;
  transition: 0.25s ease;
}

.panel select:hover {
  background: #e6f1ff;
}

/* √çCONO redondo moderno */
.btn-icono {
  width: 45px;
  height: 45px;
  background: white;
  color: #1E6FB8;
  border-radius: 50%;
  display: flex !important;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: 0.25s ease;
  padding: 0 !important;

  /* üî• evita vibraci√≥n del panel */
  position: relative;
}

.btn-icono:hover {
  background: #e6f1ff;
  transform: translateY(-2px);

  /* üî• evita reflow y elimina el temblor */
  position: relative;
}


.btn-icono:active {
  transform: scale(0.93);
}

button {
  padding: 10px 15px;
  background: #1E6FB8;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 6px;
}

button:hover {
  background: #145893;
}

select {
  padding: 8px;
  border-radius: 5px;
}

/* TABLA CON EFECTO CRISTAL ‚Äì SE VE PERFECTA SOBRE CUALQUIER FONDO */
table {
  width: 95%;
  margin: 15px auto;
  border-collapse: collapse;
  background: rgba(255, 255, 255, 0.92);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 10px 35px rgba(0, 0, 0, 0.18);
  backdrop-filter: blur(10px);
}
th, td {
  padding: 8px;
  text-align: center;
  border: 1px solid #ccc;
  color: #000;
}

th {
  background: #cfe3ff;
  font-weight: bold;
}

.filaSel {
  background-color: #cbe0ff !important;
}

/* Bot√≥n Detener ‚Äì pulso bien visible pero elegante */
.boton-detener {
  background: #c62828 !important;     /* rojo oscuro bonito */
  color: white !important;
  position: relative;
  overflow: hidden;
  animation: pulsoFuerte 1.8s infinite ease-in-out !important;
  box-shadow: 0 6px 20px rgba(198, 40, 40, 0.5) !important;
  transition: transform 0.15s ease;
  z-index: 1;
}

/* Onda blanca que cruza el bot√≥n ‚Äì se nota mucho */
.boton-detener::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transform: skewX(-25deg);
  animation: brilloCruzado 1.8s infinite ease-in-out;
  pointer-events: none;
}

.boton-detener:active {
  transform: scale(0.96);
}

/* Pulso de sombra + peque√±o cambio de tono para que se sienta vivo */
@keyframes pulsoFuerte {
  0%, 100% {
    background: #c62828 !important;
    box-shadow: 0 6px 20px rgba(198,40,40,0.5);
  }
  50% {
    background: #e53935 !important;   /* rojo un poco m√°s claro en el medio */
    box-shadow: 0 10px 35px rgba(229,57,53,0.8);
  }
}

/* Brillo que cruza el bot√≥n ‚Äì esto es lo que hace que se note mucho */
@keyframes brilloCruzado {
  0%   { left: -100%; }
  50%  { left: 100%; }
  100% { left: 100%; }
}

.subtitulo-moderno {
  margin-top: 12px;
  text-align: center;
  font-weight: 700;
  font-size: clamp(22px, 3vw, 34px);
  color: #1E6FB8;
  letter-spacing: 0.5px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;

  padding: 10px 20px;
  background: linear-gradient(135deg, #e6f1ff, #d1e3ff);
  border-radius: 12px;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.titulo-label {
  opacity: 0.9;
}

.titulo-mes {
  color: #1E6FB8;
  font-weight: 900;
}



  /* ====================== AVISO MODERNO PERSONALIZADO ====================== */
.aviso-contenedor {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  backdrop-filter: blur(4px);
}
.aviso-contenedor.mostrar {
  opacity: 1;
  visibility: visible;
}
.aviso {
  background: white;
  padding: 28px 32px;
  border-radius: 20px;
  max-width: 90%;
  width: 420px;
  text-align: center;
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
  transform: scale(0.9) translateY(20px);
  transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.aviso-contenedor.mostrar .aviso {
  transform: scale(1) translateY(0);
}
.aviso i {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}
.aviso.exito i   { color: #28a745; }
.aviso.info i    { color: #17a2b8; }
.aviso.alerta i  { color: #ffc107; }
.aviso.error i   { color: #dc3545; }

.aviso h3 {
  margin: 0 0 12px;
  font-size: 22px;
  color: #1E6FB8;
}
.aviso p {
  margin: 0 0 20px;
  color: #333;
  font-size: 16px;
  line-height: 1.5;
}
.aviso button {
  background: #1E6FB8;
  color: white;
  border: none;
  padding: 12px 28px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.25s;
}
.aviso button:hover {
  background: #145893;
  transform: translateY(-2px);
}
.aviso button:active {
  transform: translateY(0);
}


/* ====================== LOADER MODERNO ====================== */
.loader-contenedor {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.65);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.4s ease;
  backdrop-filter: blur(8px);
}
.loader-contenedor.activo {
  opacity: 1;
  visibility: visible;
}

.loader {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: conic-gradient(from 0deg, #1E6FB8, #0d47a1, #1E6FB8);
  animation: girar 1.8s linear infinite;
  position: relative;
}
.loader::before {
  content: '';
  position: absolute;
  inset: 8px;
  background: #f1f5f9;
  border-radius: 50%;
}
.loader::after {
  content: '';
  position: absolute;
  top: -12px; left: 50%;
  width: 12px; height: 12px;
  background: #1E6FB8;
  border-radius: 50%;
  transform: translateX(-50%);
  box-shadow: 0 0 20px #1E6FB8;
}

@keyframes girar {
  to { transform: rotate(360deg); }
}

/* Texto opcional debajo del loader */
.loader-texto {
  margin-top: 24px;
  color: white;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 1px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

/* ==================== TEMAS PASTELES ‚Äì AHORA PERFECTOS ==================== */
body.tema-claro   { --fondo:#ffffff; --texto:#000000; --acento:#1E6FB8; --tabla-fondo:rgba(255,255,255,0.94); --tabla-texto:#000; --borde:#ddd; --fila-sel:#cbe0ff; }
body.tema-oscuro  { --fondo:#0d1117; --texto:#ffffff; --acento:#58a6ff; --tabla-fondo:transparent; --tabla-texto:#ffffff; --borde:#30363d; --fila-sel:rgba(88,166,255,0.25); }
body.tema-oscuro header, body.tema-oscuro .panel { background: #161b22 !important; }

/* A√ëADIDO: texto negro en los botones y select del panel cuando est√° en modo oscuro */
body.tema-oscuro .panel button,
body.tema-oscuro .panel select { color: #000000 !important; }

/* El resto de temas sin cambios */
body.tema-rosado { --fondo:#fff0f6; --texto:#5d1738; --acento:#e91e63; --tabla-fondo:rgba(255,240,250,0.96); --tabla-texto:#5d1738; --borde:#f1c0d9; --fila-sel:#f8b4d9; }
body.tema-lila    { --fondo:#f8f1ff; --texto:#4a1e6e; --acento:#a855f7; --tabla-fondo:rgba(240,230,255,0.96); --tabla-texto:#4a1e6e; --borde:#d8b4ff; --fila-sel:#c48aff; }
body.tema-beige   { --fondo:#fdf6f0; --texto:#5d4037; --acento:#8d6e63; --tabla-fondo:rgba(253,248,240,0.96); --tabla-texto:#5d4037; --borde:#e0d4c8; --fila-sel:#d7ccc8; }
body.tema-verde   { --fondo:#f0fdf4; --texto:#164028; --acento:#22c55e; --tabla-fondo:rgba(240,253,244,0.96); --tabla-texto:#164028; --borde:#bbf7d0; --fila-sel:#86efac; }
body.tema-gris    { --fondo:#f5f5f5; --texto:#37474f; --acento:#607d8b; --tabla-fondo:rgba(250,250,250,0.96); --tabla-texto:#37474f; --borde:#cfd8dc; --fila-sel:#b0bec5; }
body.tema-naranja { --fondo:#fff8f0; --texto:#5d2f10; --acento:#fb923c; --tabla-fondo:rgba(255,245,230,0.96); --tabla-texto:#5d2f10; --borde:#ffcc80; --fila-sel:#ffab91; }
/* Aplicar colores a todo */
body { 
  background: var(--fondo) !important; 
  color: var(--texto) !important; 
}
header, .panel { background: var(--acento) !important; color: white !important; }
#subtitulo { background: var(--tabla-fondo) !important; color: var(--acento) !important; }
#subtitulo span { color: var(--texto) !important; }

/* Tabla perfecta en todos los temas */
table {
  background: var(--tabla-fondo) !important;
  color: var(--tabla-texto) !important;
  border-color: var(--borde) !important;
}
th {
  background: color-mix(in srgb, var(--acento) 12%, var(--tabla-fondo)) !important;
  color: var(--tabla-texto) !important;
}
td, th { border-color: var(--borde) !important; }
.filaSel { background-color: var(--fila-sel) !important; }

/* Botones y select del panel */
.panel button, .panel select { 
  background: white !important; 
  color: var(--acento) !important; 
}
.panel button:hover, .panel select:hover { background: #f0f0ff !important; }
  

</style>
</head>
<body>

<header>Asistencia IPUC Bochica Sur</header>

<div id="subtitulo" class="subtitulo-moderno">
  <span class="titulo-label">Asistencia de:</span>
  <span id="mesActual" class="titulo-mes"></span>
</div>


<!-- üîΩ TABLA ARRIBA -->
<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<!-- üîΩ PANEL AHORA ABAJO -->
<div class="panel">
  <button onclick="verMesActual()">
    <i class="fa-solid fa-calendar-days"></i> Mes Actual
  </button>

  <button onclick="verHoy()">
    <i class="fa-solid fa-calendar-check"></i> Hoy
  </button>

  <select id="selectMes"></select>

  <select id="pantallaSelect">
    <option>Selecciona pantalla</option>
  </select>

  <button onclick="proyectar()">
    <i class="fa-solid fa-display"></i> Proyectar
  </button>

  <!-- BOT√ìN DE TEMAS -->
<button id="btnTema" class="btn-icono" title="Cambiar tema">
  <i class="fa-solid fa-palette"></i>
  
  <!-- SOLO √çCONO AWESOME -->
  <button class="btn-icono" onclick="Pantallas()">
    <i class="fa-solid fa-tv"></i>
  </button>


</button>
  
</div>



<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

  <div style="height: 120px;"></div>

<!-- AVISO PERSONALIZADO -->
<div id="avisoContenedor" class="aviso-contenedor">
  <div class="aviso" id="aviso">
    <i id="avisoIcono"></i>
    <h3 id="avisoTitulo">T√≠tulo</h3>
    <p id="avisoMensaje">Mensaje aqu√≠</p>
    <button onclick="cerrarAviso()">Aceptar</button>
  </div>
</div>


<!-- LOADER MODERNO -->
<div id="loaderContenedor" class="loader-contenedor">
  <div>
    <div class="loader"></div>
    <div class="loader-texto" id="loaderTexto">Cargando...</div>
  </div>
</div>

  
<script>
const URL = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";
const meses = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let filaSeleccionada = null;
let ventanaProyeccion = null;
  let yaEstaHoyCargado = false;        // ‚Üê indica si ya mostramos la asistencia de hoy
let intervaloPolling = null;         // ‚Üê para poder detenerlo cuando ya est√©


// ==================== SISTEMA DE TEMAS PASTELES ====================
const temas = ["claro","oscuro","rosado","lila","beige","verde","gris","naranja"];
let temaActual = localStorage.getItem("tema") || "claro";

function aplicarTema(tema) {
  document.body.classList.remove(...temas.map(t => "tema-"+t));
  document.body.classList.add("tema-"+tema);
  localStorage.setItem("tema", tema);
}

document.getElementById("btnTema").addEventListener("click", () => {
  let indice = temas.indexOf(temaActual);
  let siguiente = temas[(indice + 1) % temas.length];
  temaActual = siguiente;
  aplicarTema(temaActual);
});

// Cargar tema guardado al iniciar
aplicarTema(temaActual);


  
// ============================================================
// LOADER MODERNO ‚Äì ACTIVAR / DESACTIVAR
// ============================================================
function mostrarLoader(texto = "Cargando...") {
  document.getElementById("loaderTexto").textContent = texto;
  document.getElementById("loaderContenedor").classList.add("activo");
}

function ocultarLoader() {
  document.getElementById("loaderContenedor").classList.remove("activo");
}

  
// ============================================================
// AVISO MODERNO PERSONALIZADO (reemplaza alert())
// ============================================================
function mostrarAviso(mensaje, tipo = "info", titulo = null) {
  const contenedor = document.getElementById("avisoContenedor");
  const aviso = document.getElementById("aviso");
  const icono = document.getElementById("avisoIcono");
  const tituloEl = document.getElementById("avisoTitulo");
  const mensajeEl = document.getElementById("avisoMensaje");

  // Tipos disponibles: exito, info, alerta, error
  const iconos = {
    exito:  "fa-solid fa-circle-check",
    info:   "fa-solid fa-circle-info",
    mostrarAvisoa: "fa-solid fa-triangle-exclamation",
    error:  "fa-solid fa-circle-xmark"
  };

  aviso.className = "aviso " + tipo;  // para el color del √≠cono
  icono.className = iconos[tipo] || iconos.info;
  tituloEl.textContent = titulo || (tipo === "exito" ? "¬°√âxito!" : tipo === "error" ? "Error" : tipo === "alerta" ? "Atenci√≥n" : "Aviso");
  mensajeEl.textContent = mensaje;

  contenedor.classList.add("mostrar");

  // Auto-cerrar despu√©s de 5 segundos (opcional, puedes quitarlo si no quieres)
  clearTimeout(contenedor.timeout);
  contenedor.timeout = setTimeout(cerrarAviso, 5000);
}

function cerrarAviso() {
  document.getElementById("avisoContenedor").classList.remove("mostrar");
}

  
// ============================================================
// DETECTAR PANTALLAS ‚Äì VERSI√ìN 100% SIN TEMBLOR NI PARPADEO
// ============================================================
async function detectarPantallas() {
  const combo = document.getElementById("pantallaSelect");

  // 1. Mostrar "Cargando..." sin tocar innerHTML completo
  if (combo.options.length === 1 && combo.options[0].text === "Selecciona pantalla") {
    combo.options[0].text = "Cargando...";
  } else {
    combo.innerHTML = "<option>Cargando...</option>";
  }
  combo.disabled = true;

  if (!("getScreenDetails" in window)) {
    combo.innerHTML = "<option>No compatible (activa flags)</option>";
    combo.disabled = false;
    return;
  }

  try {
    const details = await window.getScreenDetails();

    // Limpiar opciones sin provocar reflow masivo
    combo.options.length = 0; // ‚Üê esto es mucho m√°s eficiente que innerHTML = ""

    const pantallasOrdenadas = [...details.screens].sort((a, b) => {
      if (a.isPrimary) return -1;
      if (b.isPrimary) return 1;
      return 0;
    });

    let indicePrincipal = 0;

    pantallasOrdenadas.forEach((screen, index) => {
      const opt = new Option(
        screen.isPrimary ? "Pantalla Principal" : `Pantalla ${index + 1}`,
        index
      );
      combo.add(opt);
      if (screen.isPrimary) indicePrincipal = index;
    });

    combo.selectedIndex = indicePrincipal;

  } catch (error) {
    combo.options.length = 0;
    combo.add(new Option("Error: Permiso denegado", ""));
    console.warn("Screen Details denegado:", error);
  }

  combo.disabled = false;
}

// ============================================================
// Cargar combo meses con el mes actual seleccionado y al principio
// ============================================================
const selectMes = document.getElementById("selectMes");
const mesActualNombre = meses[new Date().getMonth()];

const optActual = document.createElement("option");
optActual.value = mesActualNombre;
optActual.textContent = mesActualNombre;
optActual.selected = true;
selectMes.appendChild(optActual);

meses.forEach(m => {
  if (m !== mesActualNombre) {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    selectMes.appendChild(opt);
  }
});

// T√≠tulo grande
document.getElementById("mesActual").textContent = mesActualNombre;

document.getElementById("mesActual").textContent = meses[new Date().getMonth()];

// ============================================================
// Cargar datos
// ============================================================
// ============================================================
// CARGAR MES (con loader + manejo de errores)
// ============================================================
async function cargarMes(mes) {
  mostrarLoader(`Cargando ${mes}...`);

  try {
    let url = `${URL}?accion=listar&mes=${encodeURIComponent(mes)}`;
    let res = await fetch(url);

    if (!res.ok) throw new Error("Error en la respuesta del servidor");

    let data = await res.json();
    pintarTabla(data);
    document.getElementById("mesActual").textContent = mes;
  } catch (err) {
    console.error(err);
    mostrarAviso("No se pudo cargar el mes. Revisa tu conexi√≥n.", "error");
  } finally {
    ocultarLoader();
  }
}

// ============================================================
// PINTAR TABLA (sin cambios, solo la dejamos igual)
// ============================================================
function pintarTabla(data) {
  const thead = document.querySelector("#tabla thead");
  const tbody = document.querySelector("#tabla tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";
  filaSeleccionada = null;

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='8'>Sin datos</td></tr>";
    return;
  }

  let headers = data[0];
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
  for (let i = 1; i < data.length; i++) {
    tbody.innerHTML += "<tr>" + data[i].map(cell => `<td>${cell}</td>`).join("") + "</tr>";
  }
}

// ============================================================
// SELECCIONAR FILA (sin cambios)
// ============================================================
document.getElementById("tabla").addEventListener("click", (e) => {
  const tr = e.target.closest("tr");
  if (!tr || tr.querySelector("th")) return;
  document.querySelectorAll(".filaSel").forEach(r => r.classList.remove("filaSel"));
  filaSeleccionada = tr;
  tr.classList.add("filaSel");
});

// ============================================================
// VER MES ACTUAL (con loader)
// ============================================================
function verMesActual() {
  yaEstaHoyCargado = true;
  if (intervaloPolling) {
    clearInterval(intervaloPolling);
    intervaloPolling = null;
  }
  cargarMes(meses[new Date().getMonth()]);
}

// ============================================================
// VER HOY (con loader + aviso autom√°tico bonito)
// ============================================================
async function verHoy() {
  yaEstaHoyCargado = true;
  if (intervaloPolling) {
    clearInterval(intervaloPolling);
    intervaloPolling = null;
  }

  mostrarLoader("Buscando asistencia de hoy...");

  try {
    let mes = meses[new Date().getMonth()];
    let url = `${URL}?accion=listar&mes=${mes}`;
    let res = await fetch(url);

    if (!res.ok) throw new Error("Error del servidor");

    let data = await res.json();
    const hoy = new Date().toLocaleDateString("es-CO");
    let filtrados = data.filter(row => row[1] && row[1].includes(hoy));

    if (filtrados.length > 0) filtrados.unshift(data[0]);

    document.getElementById("mesActual").textContent = "Hoy";
    pintarTabla(filtrados);

    // Si se llam√≥ desde el polling autom√°tico ‚Üí aviso bonito
    if (window.llamadoDesdePolling) {
      mostrarAviso("¬°La asistencia de hoy ya fue cargada! Se actualiz√≥ autom√°ticamente.", "exito");
      window.llamadoDesdePolling = false;
    }
  } catch (err) {
    console.error(err);
    mostrarAviso("Error al buscar la asistencia de hoy", "error");
  } finally {
    ocultarLoader();
  }
}


// === CARGA AUTOM√ÅTICA AL CAMBIAR EL MES ===
document.getElementById("selectMes").addEventListener("change", function() {
  const mes = this.value;
  yaEstaHoyCargado = true;                // evita polling si el usuario cambia manualmente
  if (intervaloPolling) {
    clearInterval(intervaloPolling);
    intervaloPolling = null;
  }
  cargarMes(mes);                          // carga inmediata
});

  

// ============================================================
// PROYECCI√ìN MODERNA ‚Äì CON AUTO-SELECCI√ìN CUANDO HAY UNA SOLA FILA
// ============================================================
async function proyectar() {
  const btn = document.querySelector("button[onclick='proyectar()']");

  // Si ya est√° proyectando ‚Üí detener
  if (ventanaProyeccion && !ventanaProyeccion.closed) {
    ventanaProyeccion.close();
    ventanaProyeccion = null;
    btn.textContent = "Proyectar";
    btn.classList.remove("boton-detener");
    return;
  }

  // === NUEVO: detectar si hay solo una fila de datos ===
  const filasDatos = document.querySelectorAll("#tabla tbody tr");
  if (filasDatos.length === 1) {
    filaSeleccionada = filasDatos[0];
    filasDatos[0].classList.add("filaSel"); // opcional: resaltar
  }
  // === FIN NUEVO ===

  // Si no hay fila seleccionada (y no es el caso de una sola fila)
  if (!filaSeleccionada) {
    mostrarAviso("Selecciona una fila antes de proyectar.");
    return;
  }

  // === Todo lo dem√°s queda 100% igual que ten√≠as ===
  let scr = null;
  if ("getScreenDetails" in window) {
    try {
      const details = await window.getScreenDetails();
      const indexPantalla = parseInt(document.getElementById("pantallaSelect").value);
      if (!isNaN(indexPantalla) && details.screens[indexPantalla]) {
        scr = details.screens[indexPantalla];
      }
    } catch (e) { /* permiso denegado ‚Üí se ignora */ }
  }

  const features = scr
    ? `left=${scr.left},top=${scr.top},width=${scr.width},height=${scr.height}`
    : `width=1200,height=700`;

  ventanaProyeccion = window.open("", "proyeccion", features);

  let headers = [...document.querySelectorAll("#tabla thead th")].map(th => th.innerText);
  let valores = [...filaSeleccionada.querySelectorAll("td")].map(td => td.innerText);

  let inicio = headers.findIndex(h => /hermano/i.test(h));
  let fin = headers.findIndex(h => /total/i.test(h));
  const totalAsistencia = valores[fin];
  const headersSinTotal = headers.slice(inicio, fin);
  const valoresSinTotal = valores.slice(inicio, fin);

  let fechaFila = valores[1] ? valores[1].trim() : "Fecha no disponible";

  function formatearFechaLarga(fechaTexto) {
    try {
      let soloFecha = fechaTexto.split(" ")[0];
      let [dia, mes, anio] = soloFecha.split("/").map(n => parseInt(n));
      const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const diasSemana = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
      const fechaObj = new Date(anio, mes - 1, dia);
      return `${diasSemana[fechaObj.getDay()]} ${dia} de ${meses[mes - 1]} de ${anio}`;
    } catch (e) {
      return fechaTexto;
    }
  }
  fechaFila = formatearFechaLarga(fechaFila);

  ventanaProyeccion.document.body.innerHTML = `
    <style>
      html,body{margin:0;padding:0;width:100vw;height:100vh;overflow:hidden;background:linear-gradient(90deg,#061b0f,#00321a 60%);font-family:'Segoe UI',sans-serif;color:#fff}
      .wrap{width:100%;height:100%;display:flex;justify-content:center;align-items:center}
      .contenedor{width:96%;height:86%;padding:28px;background:rgba(255,255,255,0.05);border-radius:20px;backdrop-filter:blur(8px);box-shadow:0 12px 50px rgba(0,0,0,0.6);display:flex;flex-direction:column;align-items:center}
      h1{margin:0 0 18px 0;font-size:calc(20px + 2.6vw);font-weight:700;text-align:center;letter-spacing:1px}
      .grid{width:100%;display:grid;grid-template-columns:repeat(${headersSinTotal.length},1fr);gap:20px}
      .card{background:rgba(255,255,255,0.08);border-radius:14px;padding:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:160px;box-shadow:0 8px 20px rgba(0,0,0,0.35)}
      .titulo{font-size:calc(12px + 1.0vw);text-transform:uppercase;font-weight:600;margin-bottom:8px;opacity:0.95}
      .valor{font-size:calc(24px + 2.8vw);font-weight:800;line-height:1}
      .total-final{margin-top:40px;padding:20px 50px;font-size:calc(26px + 3vw);font-weight:900;background:rgba(255,255,255,0.15);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.45);text-align:center}
      @keyframes fadeIn{from{opacity:0;transform:translateY(6px) scale(0.98)}to{opacity:1;transform:none}}
      .contenedor{animation:fadeIn .5s ease-out}
    </style>
    <div class="wrap"><div class="contenedor">
      <h1>${fechaFila}</h1>
      <div class="grid">
        ${headersSinTotal.map((h,i) => `<div class="card"><div class="titulo">${h}</div><div class="valor">${valoresSinTotal[i]}</div></div>`).join("")}
      </div>
      <div class="total-final">Total: ${totalAsistencia}</div>
    </div></div>
  `;

  btn.textContent = "Detener";
  btn.classList.add("boton-detener");

  const timer = setInterval(() => {
    if (!ventanaProyeccion || ventanaProyeccion.closed) {
      clearInterval(timer);
      ventanaProyeccion = null;
      btn.textContent = "Proyectar";
      btn.classList.remove("boton-detener");
    }
  }, 500);
}




// ============================================================
// CARGA AUTOM√ÅTICA INTELIGENTE AL INICIAR LA P√ÅGINA
// ============================================================
async function cargarAlIniciar() {
  const hoy = new Date().toLocaleDateString("es-CO");
  const mesActual = meses[new Date().getMonth()];

  try {
    let res = await fetch(`${URL}?accion=listar&mes=${mesActual}`);
    let data = await res.json();

    const filaHoy = data.find(row => Array.isArray(row) && row[1] && row[1].includes(hoy));

    if (filaHoy) {
      // Ya existe hoy ‚Üí mostramos solo hoy y marcamos bandera
      yaEstaHoyCargado = true;
      const filtrados = [data[0]];
      data.forEach(row => {
        if (Array.isArray(row) && row[1] && row[1].includes(hoy)) filtrados.push(row);
      });
      document.getElementById("mesActual").textContent = "Hoy";
      pintarTabla(filtrados);
    } else {
      // No hay hoy ‚Üí mostramos el mes completo
      document.getElementById("mesActual").textContent = mesActual;
      pintarTabla(data);

      // === AQU√ç EMPIEZA EL POLLING AUTOM√ÅTICO ===
      if (!intervaloPolling) {
        intervaloPolling = setInterval(verificarSiYaSubieronAsistenciaDeHoy, 30000); // cada 30 segundos
        console.log("Polling activado: revisando cada 30 seg si subieron la asistencia de hoy");
      }
    }
  } catch (err) {
    console.error("Error al cargar al iniciar:", err);
    cargarMes(mesActual);
  }
}


// ============================================================
// FUNCI√ìN QUE REVISA CADA CIERTO TIEMPO SI YA SUBIERON LA ASISTENCIA DE HOY
// ============================================================
async function verificarSiYaSubieronAsistenciaDeHoy() {
  if (yaEstaHoyCargado) return; // Ya la tenemos ‚Üí no hacemos nada m√°s

  const hoy = new Date().toLocaleDateString("es-CO");
  const mesActual = meses[new Date().getMonth()];

  try {
    let res = await fetch(`${URL}?accion=listar&mes=${mesActual}`);
    let data = await res.json();

    // Buscamos si existe alguna fila con la fecha de hoy
    const existeHoy = data.some(row => 
      Array.isArray(row) && row[1] && row[1].includes(hoy)
    );

    if (existeHoy) {
      // ¬°¬°APARECI√ì LA ASISTENCIA DE HOY!!
      yaEstaHoyCargado = true;
      clearInterval(intervaloPolling);   // detenemos el polling
      intervaloPolling = null;

      window.llamadoDesdePolling = true;  // bandera para saber que viene del polling
await verHoy();                  // mostramos autom√°ticamente "Hoy"
      document.getElementById("mesActual").textContent = "Hoy"; // por si acaso
      
    }
  } catch (err) {
    console.warn("Error en polling de asistencia hoy:", err);
    // No hacemos nada, sigue intentando en el pr√≥ximo ciclo
  }
}

  
// Ejecuta TODO apenas el HTML est√© parseado (mucho antes que "load")
document.addEventListener("DOMContentLoaded", () => {
  detectarPantallas();
  cargarAlIniciar();
});
</script>
</body>
</html>









