<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistencia IPUC Bochica Sur</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0a5c30" />

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f1f5f1;
  }

  header {
    background: #0a5c30;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }

  #subtitulo {
    text-align: center;
    margin-top: 5px;
    font-size: 18px;
    font-weight: bold;
  }

  .panel {
    padding: 15px;
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  button {
    padding: 10px 15px;
    background: #0a5c30;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 6px;
  }

  button:hover {
    background: #0f7f47;
  }

  select {
    padding: 8px;
    border-radius: 5px;
  }

  table {
    width: 95%;
    margin: 15px auto;
    border-collapse: collapse;
    background: white;
  }

  th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid #ccc;
  }

  th {
    background: #d9ead3;
    font-weight: bold;
  }

  .filaSel {
    background-color: #c7ffd1 !important;
  }

.boton-detener {
  background: red !important;
  animation: fadeRojo 1.6s infinite ease-in-out;
}

@keyframes fadeRojo {
  0%   { background: rgba(255, 0, 0, 0.50); }
  50%  { background: rgba(255, 0, 0, 1); }
  100% { background: rgba(255, 0, 0, 0.50); }
}



  
</style>
</head>
<body>

<header>Asistencia IPUC Bochica Sur DH</header>

<div id="subtitulo">Asistencia de: <span id="mesActual"></span></div>

<div class="panel">
  <button onclick="verMesActual()">Ver Mes Actual</button>
  <button onclick="verHoy()">Ver Hoy</button>

  <select id="selectMes"></select>
  <button onclick="buscarMes()">Buscar</button>

  <select id="pantallaSelect">
    <option>Selecciona pantalla</option>
  </select>
  <button onclick="proyectar()">Proyectar</button>
  <button onclick="detectarPantallas()">Cargar pantallas</button>
</div>

<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";
const meses = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let filaSeleccionada = null;
  let ventanaProyeccion = null;


// ============================================================
// üîµ DETECTAR PANTALLAS
// ============================================================
async function detectarPantallas() {
  const combo = document.getElementById("pantallaSelect");
  combo.innerHTML = "<option>Cargando...</option>";

  if (!("getScreenDetails" in window)) {
    combo.innerHTML = "<option>No compatible (activa chrome://flags)</option>";
    return;
  }

  try {
    const details = await window.getScreenDetails();
    combo.innerHTML = "";

    details.screens.forEach((screen, index) => {
      const opt = document.createElement("option");
      opt.value = index;
      opt.textContent =
        `Pantalla ${index + 1} - ${screen.width}x${screen.height}` +
        (screen.isPrimary ? " (Principal)" : "");
      combo.appendChild(opt);
    });

  } catch (error) {
    combo.innerHTML = "<option>Error: No autorizado</option>";
  }
}

// ============================================================
// Cargar combo meses
// ============================================================
const selectMes = document.getElementById("selectMes");
meses.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m;
  opt.textContent = m;
  selectMes.appendChild(opt);
});

document.getElementById("mesActual").textContent = meses[new Date().getMonth()];

// ============================================================
// Cargar datos
// ============================================================
async function cargarMes(mes) {
  let url = `${URL}?accion=listar&mes=${encodeURIComponent(mes)}`;

  let res = await fetch(url);
  let data = await res.json();
  pintarTabla(data);

  document.getElementById("mesActual").textContent = mes;
}

function pintarTabla(data) {
  const thead = document.querySelector("#tabla thead");
  const tbody = document.querySelector("#tabla tbody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  filaSeleccionada = null;

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='8'>Sin datos</td></tr>";
    return;
  }

  let headers = data[0];
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  for (let i = 1; i < data.length; i++) {
    tbody.innerHTML +=
      "<tr>" +
      data[i].map(cell => `<td>${cell}</td>`).join("") +
      "</tr>";
  }
}

// ============================================================
// Seleccionar fila completa
// ============================================================
document.getElementById("tabla").addEventListener("click", (e) => {
  const tr = e.target.closest("tr");

  if (!tr || tr.querySelector("th")) return;

  document.querySelectorAll(".filaSel").forEach(r => r.classList.remove("filaSel"));

  filaSeleccionada = tr;

  tr.classList.add("filaSel");
});

// ============================================================
// Ver Mes Actual
// ============================================================
function verMesActual() {
  cargarMes(meses[new Date().getMonth()]);
}

// ============================================================
// Ver Hoy
// ============================================================
async function verHoy() {
  let mes = meses[new Date().getMonth()];
  let url = `${URL}?accion=listar&mes=${mes}`;
  let res = await fetch(url);
  let data = await res.json();

  const hoy = new Date().toLocaleDateString("es-CO");
  let filtrados = data.filter(row => row[1] && row[1].includes(hoy));

  if (filtrados.length > 0) filtrados.unshift(data[0]);

  document.getElementById("mesActual").textContent = "Hoy";
  pintarTabla(filtrados);
}

// ============================================================
// Buscar mes
// ============================================================
function buscarMes() {
  cargarMes(selectMes.value);
}

// ============================================================
// PROYECCI√ìN MODERNA ‚Äì FILA COMPLETA
// ============================================================
async function proyectar() {
  const btn = document.querySelector("button[onclick='proyectar()']");

  // =============================
  // SI YA EST√Å PROYECTANDO ‚Üí DETENER
  // =============================
  if (ventanaProyeccion && !ventanaProyeccion.closed) {
    ventanaProyeccion.close();
    ventanaProyeccion = null;

    btn.textContent = "Proyectar";
    btn.classList.remove("boton-detener");
    return;
  }

  // =============================
  // VALIDAR FILA
  // =============================
  if (!filaSeleccionada) {
    alert("Selecciona una fila antes de proyectar.");
    return;
  }

  // =============================
  // PANTALLA
  // =============================
  const details = await window.getScreenDetails();
  const indexPantalla = parseInt(document.getElementById("pantallaSelect").value);
  const scr = details.screens[indexPantalla];

  ventanaProyeccion = window.open(
    "",
    "proyeccion",
    `left=${scr.left},top=${scr.top},width=${scr.width},height=${scr.height}`
  );

  // =============================
  // OBTENER ENCABEZADOS Y DATOS
  // =============================
  let headers = [...document.querySelectorAll("#tabla thead th")].map(th => th.innerText);
  let valores = [...filaSeleccionada.querySelectorAll("td")].map(td => td.innerText);

  // ============================================
  // QUITA: FECHA, REGISTRADO POR, OTROS CAMPOS
  // (Asumo primeras columnas: ID, Fecha, Nombre, RegistradoPor)
  // SOLO MOSTRAR: Hermano ‚Üí Total asistencia
  // ============================================
  let inicio = headers.findIndex(h => h.toLowerCase().includes("hermano"));
  let fin = headers.findIndex(h => h.toLowerCase().includes("total"));

  let h2 = headers.slice(inicio, fin + 1);
  let v2 = valores.slice(inicio, fin + 1);

  // =============================
  // FECHA PARA EL T√çTULO
  // =============================
  let fechaTexto = valores[1]; // columna Fecha real
  let fecha = new Date(fechaTexto);
  let opciones = { weekday: "long", day: "numeric", month: "long" };
  let fechaFormateada = fecha.toLocaleDateString("es-CO", opciones);

  fechaFormateada =
    fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);

  // =============================
  // DISE√ëO MEJORADO
  // AUTO-ESCALA PARA NO SALIRSE
  // =============================
  ventanaProyeccion.document.body.innerHTML = `
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: #002a18;
        font-family: 'Segoe UI', sans-serif;
      }

      .wrap {
        transform-origin: center;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .contenedor {
        width: 92%;
        padding: 40px;
        background: rgba(255,255,255,0.10);
        border-radius: 25px;
        backdrop-filter: blur(12px);
        box-shadow: 0 0 45px rgba(0,0,0,0.5);
        color: white;
        animation: fadeIn 0.6s ease-out;
      }

      h1 {
        font-size: 4.2vw;
        text-align: center;
        margin-bottom: 2vh;
        font-weight: 700;
        letter-spacing: 2px;
      }

      .fila {
        display: grid;
        grid-template-columns: repeat(${h2.length}, 1fr);
        gap: 1.4vw;
      }

      .item {
        background: rgba(255,255,255,0.18);
        padding: 1.6vw;
        border-radius: 18px;
        text-align: center;
      }

      .titulo {
        font-size: 2vw;
        margin-bottom: 0.8vw;
        text-transform: uppercase;
        font-weight: 600;
      }

      .valor {
        font-size: 3.5vw;
        font-weight: bold;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
      }
    </style>

    <div class="wrap">
      <div class="contenedor">
        <h1>Asistencia del d√≠a ${fechaFormateada}</h1>

        <div class="fila">
          ${
            h2.map((h,i)=>`
              <div class="item">
                <div class="titulo">${h}</div>
                <div class="valor">${v2[i]}</div>
              </div>
            `).join("")
          }
        </div>
      </div>
    </div>

    <script>
      function autoAjustar() {
        const wrap = document.querySelector('.wrap');
        const w = window.innerWidth;
        const h = window.innerHeight;

        wrap.style.transform =
          "scale(" + Math.min(w / 1920, h / 1080) + ")";
      }
      window.onload = autoAjustar;
      window.onresize = autoAjustar;
    </script>
  `;

  // =============================
  // BOT√ìN DETENER
  // =============================
  btn.textContent = "Detener";
  btn.classList.add("boton-detener");

  // Detectar cierre manual
  let timer = setInterval(() => {
    if (!ventanaProyeccion || ventanaProyeccion.closed) {
      clearInterval(timer);
      ventanaProyeccion = null;
      btn.textContent = "Proyectar";
      btn.classList.remove("boton-detener");
    }
  }, 500);
}


// ============================================================
// Auto cargar pantallas
// ============================================================
window.addEventListener("load", detectarPantallas);

</script>
</body>
</html>



