<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistencia IPUC Bochica Sur</title>

<link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<meta name="theme-color" content="#0a5c30" />

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f1f5f9;
    color: #000; /* TEXTO NEGRO GLOBAL */
  }

  header {
    background: #1E6FB8;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }

 /* SUBT√çTULO PRINCIPAL GRANDE Y MODERNO */
#subtitulo {
  margin-top: 18px;
  text-align: center;
  font-size: clamp(26px, 3.2vw, 40px);
  font-weight: 800;
  letter-spacing: 1px;
  color: #1E6FB8; 
  padding: 12px 26px;
  background: linear-gradient(135deg, #eaf4ff, #d4e9ff);
  border-radius: 14px;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 4px 14px rgba(0,0,0,0.18);
  border: 2px solid #1E6FB8;
}

#subtitulo span {
  color: #000;
  font-weight: 900;
  text-transform: capitalize;
}


 /* PANEL FIJO MODERNO */
.panel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 14px 20px;
  background: rgba(30, 111, 184, 0.92); /* AZUL */
  backdrop-filter: blur(6px);
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: nowrap;
  z-index: 9999;
  box-shadow: 0 -6px 20px rgba(0,0,0,0.25);
}

/* BOTONES PROFESIONALES */
.panel button {
  padding: 10px 18px;
  font-size: 15px;
  border-radius: 10px;
  border: none;
  background: white;
  color: #1E6FB8;
  font-weight: 600;
  cursor: pointer;
  transition: 0.25s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel button:hover {
  background: #e6f1ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.panel button:active {
  transform: scale(0.97);
}

/* SELECT STYLE MODERNO */
.panel select {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  background: #ffffff;
  font-weight: 600;
  color: #1E6FB8;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
  cursor: pointer;
  transition: 0.25s ease;
}

.panel select:hover {
  background: #e6f1ff;
}

/* √çCONO redondo moderno */
.btn-icono {
  width: 45px;
  height: 45px;
  background: white;
  color: #1E6FB8;
  border-radius: 50%;
  display: flex !important;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: 0.25s ease;
  padding: 0 !important;
}

.btn-icono:hover {
  background: #e6f1ff;
  transform: translateY(-2px);
}

.btn-icono:active {
  transform: scale(0.93);
}

button {
  padding: 10px 15px;
  background: #1E6FB8;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 6px;
}

button:hover {
  background: #145893;
}

select {
  padding: 8px;
  border-radius: 5px;
}

table {
  width: 95%;
  margin: 15px auto;
  border-collapse: collapse;
  background: white;
}

th, td {
  padding: 8px;
  text-align: center;
  border: 1px solid #ccc;
  color: #000;
}

th {
  background: #cfe3ff;
  font-weight: bold;
}

.filaSel {
  background-color: #cbe0ff !important;
}

/* Bot√≥n detener - fade suave */
.boton-detener {
  background: red !important;
  animation: fadeRojo 1.6s infinite ease-in-out;
  transition: background 0.5s ease, transform 0.15s ease;
  box-shadow: 0 6px 18px rgba(255,0,0,0.15);
}

.boton-detener:active { transform: scale(0.98); }

@keyframes fadeRojo {
  0%   { background: rgba(255, 0, 0, 0.50); }
  50%  { background: rgba(255, 0, 0, 1); }
  100% { background: rgba(255, 0, 0, 0.50); }
}

.subtitulo-moderno {
  margin-top: 12px;
  text-align: center;
  font-weight: 700;
  font-size: clamp(22px, 3vw, 34px);
  color: #1E6FB8;
  letter-spacing: 0.5px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;

  padding: 10px 20px;
  background: linear-gradient(135deg, #e6f1ff, #d1e3ff);
  border-radius: 12px;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.titulo-label {
  opacity: 0.9;
}

.titulo-mes {
  color: #1E6FB8;
  font-weight: 900;
}



</style>
</head>
<body>

<header>Asistencia IPUC Bochica Sur</header>

<div id="subtitulo" class="subtitulo-moderno">
  <span class="titulo-label">Asistencia de:</span>
  <span id="mesActual" class="titulo-mes"></span>
</div>


<!-- üîΩ TABLA ARRIBA -->
<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<!-- üîΩ PANEL AHORA ABAJO -->
<div class="panel">
  <button onclick="verMesActual()">
    <i class="fa-solid fa-calendar-days"></i> Mes Actual
  </button>

  <button onclick="verHoy()">
    <i class="fa-solid fa-calendar-check"></i> Hoy
  </button>

  <select id="selectMes"></select>

  <button onclick="buscarMes()">
    <i class="fa-solid fa-search"></i> Buscar
  </button>

  <select id="pantallaSelect">
    <option>Selecciona pantalla</option>
  </select>

  <button onclick="proyectar()">
    <i class="fa-solid fa-display"></i> Proyectar
  </button>

  <!-- SOLO √çCONO AWESOME -->
  <button class="btn-icono" onclick="detectarPantallas()">
    <i class="fa-solid fa-tv"></i>
  </button>
</div>



<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

  <div style="height: 120px;"></div>


<script>
const URL = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";
const meses = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let filaSeleccionada = null;
let ventanaProyeccion = null;

// ============================================================
// üîµ DETECTAR PANTALLAS
// ============================================================
// ============================================================
// DETECTAR PANTALLAS (mejorado sin afectar nada m√°s)
// ============================================================
async function detectarPantallas() {
  const combo = document.getElementById("pantallaSelect");

  // bloqueado sin ocultar ‚Äî evita parpadeo
  combo.style.opacity = "0.4";
  combo.style.pointerEvents = "none";
  combo.innerHTML = "<option>Cargando...</option>";

  if (!("getScreenDetails" in window)) {
    combo.innerHTML = "<option>No compatible (activa chrome://flags)</option>";
    combo.style.opacity = "1";
    combo.style.pointerEvents = "auto";
    return;
  }

  try {
    const details = await window.getScreenDetails();
    combo.innerHTML = "";

    // Ordenar: principal primero
    const pantallasOrdenadas = [...details.screens].sort((a, b) => {
      if (a.isPrimary) return -1;
      if (b.isPrimary) return 1;
      return 0;
    });

    let indexSeleccion = 0;

    pantallasOrdenadas.forEach((screen, index) => {
      const opt = document.createElement("option");
      opt.value = index;

      if (screen.isPrimary) {
        opt.textContent = "Pantalla Principal";
        indexSeleccion = index;
      } else {
        opt.textContent = `Pantalla ${index + 1}`;
      }

      combo.appendChild(opt);
    });

    combo.selectedIndex = indexSeleccion;

  } catch (error) {
    combo.innerHTML = "<option>Error: No autorizado</option>";
  }

  // restaurar normal
  combo.style.opacity = "1";
  combo.style.pointerEvents = "auto";
}


// ============================================================
// Cargar combo meses
// ============================================================
const selectMes = document.getElementById("selectMes");
meses.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m;
  opt.textContent = m;
  selectMes.appendChild(opt);
});

document.getElementById("mesActual").textContent = meses[new Date().getMonth()];

// ============================================================
// Cargar datos
// ============================================================
async function cargarMes(mes) {
  let url = `${URL}?accion=listar&mes=${encodeURIComponent(mes)}`;

  let res = await fetch(url);
  let data = await res.json();
  pintarTabla(data);

  document.getElementById("mesActual").textContent = mes;
}

function pintarTabla(data) {
  const thead = document.querySelector("#tabla thead");
  const tbody = document.querySelector("#tabla tbody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  filaSeleccionada = null;

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='8'>Sin datos</td></tr>";
    return;
  }

  let headers = data[0];
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  for (let i = 1; i < data.length; i++) {
    tbody.innerHTML +=
      "<tr>" +
      data[i].map(cell => `<td>${cell}</td>`).join("") +
      "</tr>";
  }
}

// ============================================================
// Seleccionar fila completa
// ============================================================
document.getElementById("tabla").addEventListener("click", (e) => {
  const tr = e.target.closest("tr");

  if (!tr || tr.querySelector("th")) return;

  document.querySelectorAll(".filaSel").forEach(r => r.classList.remove("filaSel"));

  filaSeleccionada = tr;

  tr.classList.add("filaSel");
});

// ============================================================
// Ver Mes Actual
// ============================================================
function verMesActual() {
  cargarMes(meses[new Date().getMonth()]);
}

// ============================================================
// Ver Hoy
// ============================================================
async function verHoy() {
  let mes = meses[new Date().getMonth()];
  let url = `${URL}?accion=listar&mes=${mes}`;
  let res = await fetch(url);
  let data = await res.json();

  const hoy = new Date().toLocaleDateString("es-CO");
  let filtrados = data.filter(row => row[1] && row[1].includes(hoy));

  if (filtrados.length > 0) filtrados.unshift(data[0]);

  document.getElementById("mesActual").textContent = "Hoy";
  pintarTabla(filtrados);
}

// ============================================================
// Buscar mes
// ============================================================
function buscarMes() {
  cargarMes(selectMes.value);
}

// ============================================================
// PROYECCI√ìN MODERNA ‚Äì FILA COMPLETA
// ============================================================
// PROYECCI√ìN MODERNA ‚Äì FILA COMPLETA (VERSI√ìN FINAL CORREGIDA)
// ============================================================
async function proyectar() {
  const btn = document.querySelector("button[onclick='proyectar()']");

  // Si ya proyecta -> detener
  if (ventanaProyeccion && !ventanaProyeccion.closed) {
    ventanaProyeccion.close();
    ventanaProyeccion = null;

    btn.textContent = "Proyectar";
    btn.classList.remove("boton-detener");
    return;
  }

  if (!filaSeleccionada) {
    alert("Selecciona una fila antes de proyectar.");
    return;
  }

  // abrir en pantalla seleccionada si existe
  let scr = null;
  if ("getScreenDetails" in window) {
    const details = await window.getScreenDetails();
    const indexPantalla = parseInt(document.getElementById("pantallaSelect").value);
    scr = details.screens[indexPantalla];
  }

  const features = scr
    ? `left=${scr.left},top=${scr.top},width=${scr.width},height=${scr.height}`
    : `width=1200,height=700`;

  ventanaProyeccion = window.open("", "proyeccion", features);

  // obtener headers y valores
  let headers = [...document.querySelectorAll("#tabla thead th")].map(th => th.innerText);
  let valores = [...filaSeleccionada.querySelectorAll("td")].map(td => td.innerText);

  // buscar √≠ndices de inicio (Hermano) y fin (Total)
  let inicio = headers.findIndex(h => /hermano/i.test(h));
  let fin = headers.findIndex(h => /total/i.test(h));

  // quitar TOTAL del grid
  const totalAsistencia = valores[fin];
  const headersSinTotal = headers.slice(inicio, fin);
  const valoresSinTotal = valores.slice(inicio, fin);

  // ============================
  // FECHA EXACTA DE LA FILA
  // ============================
  let fechaFila = valores[1] ? valores[1].trim() : "Fecha no disponible";

  // -----------------------------------------------------
  // FORMATEAR A: "s√°bado 1 de noviembre de 2025"
  // -----------------------------------------------------
  function formatearFechaLarga(fechaTexto) {
    try {
      // tomar solo "DD/MM/YYYY"
      let soloFecha = fechaTexto.split(" ")[0];
      let [dia, mes, anio] = soloFecha.split("/").map(n => parseInt(n));

      const meses = [
        "enero","febrero","marzo","abril","mayo","junio",
        "julio","agosto","septiembre","octubre","noviembre","diciembre"
      ];

      const diasSemana = [
        "domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"
      ];

      const fechaObj = new Date(anio, mes - 1, dia);

      let nombreDia = diasSemana[fechaObj.getDay()];
      let nombreMes = meses[mes - 1];

      return `${nombreDia} ${dia} de ${nombreMes} de ${anio}`;
    } catch (e) {
      return fechaTexto;
    }
  }

  fechaFila = formatearFechaLarga(fechaFila);

  // ============================
  // HTML PROYECTADO
  // ============================
  ventanaProyeccion.document.body.innerHTML = `
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(90deg,#061b0f,#00321a 60%);
        font-family: 'Segoe UI', sans-serif;
        color: #fff;
      }

      .wrap {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .contenedor {
        width: 96%;
        height: 86%;
        padding: 28px;
        background: rgba(255,255,255,0.05);
        border-radius: 20px;
        backdrop-filter: blur(8px);
        box-shadow: 0 12px 50px rgba(0,0,0,0.6);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        margin: 0 0 18px 0;
        font-size: calc(20px + 2.6vw);
        font-weight: 700;
        text-align: center;
        letter-spacing: 1px;
      }

      .grid {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(${headersSinTotal.length}, 1fr);
        gap: 20px;
        align-items: stretch;
      }

      .card {
        background: rgba(255,255,255,0.08);
        border-radius: 14px;
        padding: 18px;
        display:flex;
        flex-direction: column;
        align-items:center;
        justify-content: center;
        min-height: 160px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      }

      .titulo {
        font-size: calc(12px + 1.0vw);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
        opacity: 0.95;
      }

      .valor {
        font-size: calc(24px + 2.8vw);
        font-weight: 800;
        line-height: 1;
      }

      .total-final {
        margin-top: 40px;
        padding: 20px 50px;
        font-size: calc(26px + 3vw);
        font-weight: 900;
        background: rgba(255,255,255,0.15);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.45);
        text-align: center;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(6px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }

      .contenedor { animation: fadeIn .5s ease-out; }
    </style>

    <div class="wrap">
      <div class="contenedor">

        <h1>Asistencia del d√≠a ${fechaFila}</h1>

        <div class="grid">
          ${
            headersSinTotal.map((h,i) => `
              <div class="card">
                <div class="titulo">${h}</div>
                <div class="valor">${valoresSinTotal[i]}</div>
              </div>
            `).join("")
          }
        </div>

        <div class="total-final">
          Total: ${totalAsistencia}
        </div>

      </div>
    </div>
  `;

  // cambiar bot√≥n a detener
  btn.textContent = "Detener";
  btn.classList.add("boton-detener");

  // monitorear cierre manual
  let timer = setInterval(() => {
    if (!ventanaProyeccion || ventanaProyeccion.closed) {
      clearInterval(timer);
      ventanaProyeccion = null;
      btn.textContent = "Proyectar";
      btn.classList.remove("boton-detener");
    }
  }, 500);
}




// ============================================================
// Auto cargar pantallas
// ============================================================
window.addEventListener("load", detectarPantallas);
</script>
</body>
</html>













