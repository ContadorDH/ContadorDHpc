<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Asistencia IPUC Bochica Sur</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0a5c30" />

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f1f5f1;
  }

  header {
    background: #0a5c30;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }

  #subtitulo {
    text-align: center;
    margin-top: 5px;
    font-size: 18px;
    font-weight: bold;
  }

  .panel {
    padding: 15px;
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  button {
    padding: 10px 15px;
    background: #0a5c30;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 6px;
  }

  button:hover {
    background: #0f7f47;
  }

  select {
    padding: 8px;
    border-radius: 5px;
  }

  table {
    width: 95%;
    margin: 15px auto;
    border-collapse: collapse;
    background: white;
  }

  th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid #ccc;
  }

  th {
    background: #d9ead3;
    font-weight: bold;
  }

</style>
</head>
<body>

<header>Asistencia IPUC Bochica Sur</header>

<div id="subtitulo">Asistencia de: <span id="mesActual"></span></div>

<div class="panel">
  <button onclick="verMesActual()">Ver Mes Actual</button>
  <button onclick="verHoy()">Ver Hoy</button>

  <select id="selectMes"></select>
  <button onclick="buscarMes()">Buscar</button>

  <select id="pantallaSelect">
    <option>Cargando pantallas...</option>
  </select>
  <button onclick="proyectar()">Proyectar</button>
</div>

<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";

const meses = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let ventanaProyeccion = null;

// ------------------------------------------------------
// PERMISO PARA USAR PANTALLAS REALES
// ------------------------------------------------------
async function solicitarPermisoPantallas() {
  if (!("getScreens" in window)) {
    console.warn("API de pantallas no soportada en este navegador.");
    return;
  }

  try {
    await window.getScreens();
  } catch (e) {
    console.error("Permiso de pantallas denegado:", e);
  }
}

solicitarPermisoPantallas();

// ------------------------------------------------------
// CARGAR PANTALLAS REALES
// ------------------------------------------------------
async function cargarPantallas() {
  const select = document.getElementById("pantallaSelect");

  if (!("getScreens" in window)) {
    select.innerHTML = "<option>No compatible</option>";
    return;
  }

  const screensObj = await window.getScreens();

  select.innerHTML = "";

  screensObj.screens.forEach((scr, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Pantalla ${i + 1} (${scr.width}x${scr.height})`;
    select.appendChild(opt);
  });
}

cargarPantallas();


// ------------------------------------------------------
// Cargar combo de meses
// ------------------------------------------------------
const selectMes = document.getElementById("selectMes");
meses.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m;
  opt.textContent = m;
  selectMes.appendChild(opt);
});

// Mes actual
document.getElementById("mesActual").textContent = meses[new Date().getMonth()];

// ------------------------------------------------------
// Función para consultar datos
// ------------------------------------------------------
async function cargarMes(mes) {
  document.getElementById("mesActual").textContent = mes;

  let url = `${URL}?accion=listar&mes=${encodeURIComponent(mes)}`;
  let res = await fetch(url);
  let data = await res.json();

  pintarTabla(data);
}

// ------------------------------------------------------
// Pintar tabla
// ------------------------------------------------------
function pintarTabla(data) {
  const thead = document.querySelector("#tabla thead");
  const tbody = document.querySelector("#tabla tbody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='8'>Sin datos</td></tr>";
    return;
  }

  let headers = data[0];
  let thRow = "<tr>";
  headers.forEach(h => thRow += `<th>${h}</th>`);
  thRow += "</tr>";
  thead.innerHTML = thRow;

  for (let i = 1; i < data.length; i++) {
    let row = "<tr>";
    data[i].forEach(cell => row += `<td>${cell}</td>`);
    row += "</tr>";
    tbody.innerHTML += row;
  }
}

// ------------------------------------------------------
// Botón: Ver Mes Actual
// ------------------------------------------------------
function verMesActual() {
  let mes = meses[new Date().getMonth()];
  cargarMes(mes);
}

// ------------------------------------------------------
// Botón: Ver Hoy
// ------------------------------------------------------
async function verHoy() {
  let mes = meses[new Date().getMonth()];
  let url = `${URL}?accion=listar&mes=${mes}`;

  let res = await fetch(url);
  let data = await res.json();

  const hoy = new Date().toLocaleDateString("es-CO");

  let filtrados = data.filter(row => row[1] && row[1].includes(hoy));
  if (filtrados.length > 0) filtrados.unshift(data[0]);

  document.getElementById("mesActual").textContent = "Hoy";
  pintarTabla(filtrados);
}

// ------------------------------------------------------
// Botón: Buscar Mes
// ------------------------------------------------------
function buscarMes() {
  let mes = selectMes.value;
  cargarMes(mes);
}

// ------------------------------------------------------
// PROYECTAR EN PANTALLA REAL
// ------------------------------------------------------
async function proyectar() {
  if (!("getScreens" in window)) {
    alert("Tu navegador no soporta proyección en pantalla externa.");
    return;
  }

  const screensObj = await window.getScreens();
  const index = parseInt(document.getElementById("pantallaSelect").value);
  const scr = screensObj.screens[index];

  const win = await window.open(
    "",
    "",
    `fullscreen=yes,left=${scr.left},top=${scr.top},
     width=${scr.width},height=${scr.height}`
  );

  win.document.body.innerHTML = `
    <style>
      body { background:white; font-family:Arial; }
      h1 { text-align:center; margin-top:20px; }
      table { width:95%; margin:auto; border-collapse: collapse; }
      th, td { border:1px solid #ccc; padding:8px; }
      th { background:#d9ead3; }
    </style>

    <h1>Asistencia ${document.getElementById("mesActual").textContent}</h1>
    ${document.getElementById("tabla").outerHTML}
  `;
}

</script>

</body>
</html>
